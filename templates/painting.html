{% extends "base.html" %}
{% block head %}
    <title>Paint Something</title>
    <!-- temporary styling -->
    <style type="text/css">
        canvas {
            border: 1px solid #000;
        }
    </style>
</head>
{% endblock %}
{% block body %}
    <div id="header">
        <h1>{{ wordChosen }}</h1>
    </div>
    <!-- The dimensions of the canvas must be set explicitly, can't use %, otherwise it will look blurry and not work -->
    <canvas id="canvas" width="600" height="400"></canvas>
    <br><br>
    <div id="button-panel">
        Color: <input type="color" id="myColor"> Line Thickness: <input type="range" id="thickness" min="1" max="15" value="5"><br>
        <a id="clear">Start Over</a><br>
        <a id="fill">Fill Mode: false</a><br><br>
        <!-- maybe add some divs here that control the color of the brush,
             and each div is the background color which it will change the brush tp -->
    </div>
    <form action="/draw/score" method="POST" id="done">
        <input type="hidden" name="word" value="{{wordChosen}}">
        <input type="submit" value="Submit Drawing">
        <!-- When the button is pressed, JS will use ninja powers to attach an <input type=hidden>
             to the form. It will be called "image" and contain canvas data as a string -->
    </form>
    <!--<script type="text/javascript" src="../static/painting.js" />-->
    <script>
      //Important Variables~~~~~~~~~~~~~~~~~~~~~~~~~
    var canvas = document.getElementById("canvas");
    var form = document.getElementById("done");
    var colorPicker = document.getElementById("myColor");
    var clearBtn = document.getElementById("clear");
    var fillBtn = document.getElementById("fill");
    var thickSlider = document.getElementById("thickness");
    var ctx = canvas.getContext("2d");
    var mousedown = false;
    var fillMode = false;
    var canFillAgain = true; //to guard against spam clicking
    var startOver, changeThickness; //we have to declare them up here for some reason
    //Event Listeners~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    canvas.addEventListener("mousemove", function(event) {
        if(mousedown == true) {
        	var color = colorPicker.value;
            if(fillMode == false) {
            	changeColor(color);
            	var x1 = event.offsetX;
            	var y1 = event.offsetY;
            	var x0 = x1 - 2 * Math.max(Math.min(event.movementX, 10), -10);
            	var y0 = y1 - 2 * Math.max(Math.min(event.movementY, 10), -10);
            	ctx.beginPath();
            	ctx.moveTo(x0, y0);
            	ctx.lineTo(x1, y1);
            	ctx.stroke();
            }
        }
    });
    canvas.addEventListener("click", function(event) {
        if(fillMode == true && canFillAgain == true) {
            canFillAgain = false;
            fill2(event.offsetX, event.offsetY, hexColorToArray(document.getElementById("myColor").value));
        }
    });
    canvas.addEventListener("mousedown", function(event) {
        mousedown = true;
    });
    canvas.addEventListener("mouseup", function(event) {
        mousedown = false;
    });
    done.addEventListener("submit", function(event) {
        var savedImage = document.createElement("input");
        savedImage.setAttribute("type", "hidden");
        savedImage.setAttribute("name", "image");
        savedImage.setAttribute("value", getImage());
        form.appendChild(savedImage);
    });
    clearBtn.addEventListener("click", startOver);
    fillBtn.addEventListener("click", function() {
        fillMode = !fillMode;
        fillBtn.innerHTML = "Fill mode: " + fillMode;
    });
    thickSlider.addEventListener("input", function() {
        changeThickness(this.value);
    });
    //Useful functions~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    startOver = function() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    };
    var changeThickness = function(t) {
        ctx.lineWidth = t;
        ctx.lineCap = "round";
        return t;
    }
    var changeColor = function(c) {
        ctx.strokeStyle = c;
        return c;
    }
    var getImage = function() {
        return canvas.toDataURL("image/png");
    }
    var setBackground = function(color) {
        ctx.fillStyle = color;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    var getColorFromImageData = function(x, y, data) {
        var start = y * data.width * 4 + x * 4;
        return data.data.slice(start, start + 4);
    }
    var setColorInImageData = function(x, y, colorArray, data) {
        var start = y * data.width * 4 + x * 4;
        data.data[start] = colorArray[0];
        data.data[start+1] = colorArray[1];
        data.data[start+2] = colorArray[2];
        data.data[start+3] = colorArray[3];
    }
    var sameColor = function(a, b) {
        for(var i = 0; i < 4; i++) {
    	   if(a[i] != b[i]) return false;
        }
        return true;
    }
    var hexColorToArray = function(hexadecimal) {
        var arr = [];
        arr[0] = parseInt(hexadecimal.substring(1,3), 16);
        arr[1] = parseInt(hexadecimal.substring(3,5), 16);
        arr[2] = parseInt(hexadecimal.substring(5,7), 16);
        arr[3] = 255; //full opacity
        return arr;
    }
    var fill2 = function(cx, cy, colorNew) {
        console.log("starting");
        var areaWidth = 100, areaHeight = 100;
        var area = ctx.getImageData(cx-areaWidth/2, cy-areaHeight/2, areaWidth, areaHeight);
        var colorOld = getColorFromImageData(areaWidth/2, areaWidth/2, area);
        if(sameColor(colorOld, colorNew)) {
            canFillAgain = true;
            return; //no need to fill the same thing
        }
        console.log("approved");
        var v = fillRecursive(areaWidth / 2, areaHeight / 2, areaWidth, areaHeight, colorNew, colorOld, area, "");
        ctx.putImageData(area, cx-areaWidth/2, cy-areaHeight/2);
        canFillAgain = true;
        console.log("done " + v.split(" ").length);
    };
    var fillRecursive = function(x, y, w, h, colorNew, colorOld, area, visitedCoordinates) {
        if(x >= 0 && y >= 0 && x < w && y < h && sameColor(getColorFromImageData(x, y, area), colorOld) == true && visitedCoordinates.indexOf(x + "," + y) == -1) {
            setColorInImageData(x, y, colorNew, area);
            visitedCoordinates += " " + x + "," + y;
            visitedCoordinates = fillRecursive(x, y-1, w, h, colorNew, colorOld, area, visitedCoordinates); //up
            visitedCoordinates = fillRecursive(x, y+1, w, h, colorNew, colorOld, area, visitedCoordinates); //down
            visitedCoordinates = fillRecursive(x+1, y, w, h, colorNew, colorOld, area, visitedCoordinates); //right
            visitedCoordinates = fillRecursive(x-1, y, w, h, colorNew, colorOld, area, visitedCoordinates); //left
        }
        return visitedCoordinates;
    };
    //Setup~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    changeColor("#000");
    changeThickness(parseInt(document.getElementById("thickness").value));
    console.log(getImage());
    </script>
{% endblock %}
